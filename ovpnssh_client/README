#
#
#
#CLIENT
#
#
#

netplan:
# This is the network config written by 'subiquity'
network:
  ethernets:
    enp0s3:
      dhcp4: false
      addresses: [192.168.2.153/24]
      gateway4: 192.168.2.1
      nameservers:
        addresses: [192.168.2.1]
      routes:
      - to: 192.168.3.153/32
        via: 192.168.2.1
      - to: 192.168.3.154/32
        via: 192.168.2.1

  version: 2

export DEBIAN_FRONTEND=noninteractive && \
apt clean && apt -y update && apt install -y --no-install-recommends vim openvpn iptables openssh-server sudo && \
#iptables-restore < iptables-save && \
cp openvpn.conf /etc/openvpn/openvpn.conf

ssh-keygen
cd $HOME
cat .ssh/id_rsa.pub
echo "StrictHostKeyChecking accept-new" >> /etc/ssh/ssh_config

iptables -A FORWARD -i enp0s3 -o enp0s3 -d 192.168.3.0/24 -j ACCEPT
iptables -A FORWARD -i enp0s3 -o enp0s3 -j DROP
iptables -t nat -I POSTROUTING -s 192.168.3.0/24 -o tun0 -j MASQUERADE

vi /etc/rc.local
#!/bin/sh -e
#
#

exit 0

chmod +x /etc/rc.local

vi /etc/systemd/system/rc-local.service

[Unit]
 Description=/etc/rc.local Compatibility
 ConditionPathExists=/etc/rc.local

[Service]
 Type=forking
 ExecStart=/etc/rc.local start
 TimeoutSec=0
 StandardOutput=tty
 RemainAfterExit=yes
 SysVStartPriority=99

[Install]
 WantedBy=multi-user.target


systemctl enable rc-local.service

ssh -l user1 -D 8080 -N 192.168.3.154 -p 2222 &
